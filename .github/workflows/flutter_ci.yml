name: Flutter Android CI

on:
  push:
    paths:
      - 'flutter_app/**/*.dart'
      - 'flutter_app/**/pubspec.yaml'
      - 'flutter_app/**/pubspec.lock'
      - 'flutter_app/**/analysis_options.yaml'
      - 'flutter_app/**/android/**'
      - 'flutter_app/**/lib/**'
      - 'flutter_app/**/test/**'
      - 'flutter_app/**/assets/**'
      - 'flutter_app/**/fonts/**'
  pull_request:
    paths:
      - 'flutter_app/**/*.dart'
      - 'flutter_app/**/pubspec.yaml'
      - 'flutter_app/**/pubspec.lock'
      - 'flutter_app/**/analysis_options.yaml'
      - 'flutter_app/**/android/**'
      - 'flutter_app/**/lib/**'
      - 'flutter_app/**/test/**'
      - 'flutter_app/**/assets/**'
      - 'flutter_app/**/fonts/**'

jobs:
  build-android:
    name: Build Android APK
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.3'
          channel: 'stable'
          cache: true
      
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          cmdline-tools-version: 12266719
          accept-android-sdk-licenses: true
          log-accepted-android-sdk-licenses: true
          packages: 'tools platform-tools'
      
      - name: Verify Flutter installation
        run: flutter doctor -v
          
      - name: Configure Flutter
        run: flutter config --no-analytics
          
      - name: Android v1 to v2 Migration
        working-directory: flutter_app/mrs_unkwn_app
        run: |
          echo "🚨 Android v1 → v2 Migration..."
          
          # Alte MainActivity Dateien entfernen
          rm -rf android/app/src/main/java/
          rm -rf android/app/src/main/kotlin/
          
          # Neue Kotlin-Struktur erstellen
          mkdir -p android/app/src/main/kotlin/com/mrsunkwn/mrs_unkwn_app
          
          # MainActivity.kt erstellen
          cat > android/app/src/main/kotlin/com/mrsunkwn/mrs_unkwn_app/MainActivity.kt << 'EOF'
          package com.mrsunkwn.mrs_unkwn_app

          import io.flutter.embedding.android.FlutterActivity

          class MainActivity: FlutterActivity() {
          }
          EOF

          # AndroidManifest.xml aktualisieren
          cat > android/app/src/main/AndroidManifest.xml << 'EOF'
          <manifest xmlns:android="http://schemas.android.com/apk/res/android"
              package="com.mrsunkwn.mrs_unkwn_app">
              
              <uses-permission android:name="android.permission.INTERNET" />
              
              <application
                  android:label="mrs_unkwn_app"
                  android:name="io.flutter.app.FlutterApplication"
                  android:icon="@mipmap/ic_launcher">
                  
                  <activity
                      android:name=".MainActivity"
                      android:exported="true"
                      android:launchMode="singleTop"
                      android:theme="@style/LaunchTheme"
                      android:windowSoftInputMode="adjustResize">
                      
                      <meta-data
                          android:name="io.flutter.embedding.android.NormalTheme"
                          android:resource="@style/NormalTheme" />
                          
                      <intent-filter>
                          <action android:name="android.intent.action.MAIN"/>
                          <category android:name="android.intent.category.LAUNCHER"/>
                      </intent-filter>
                  </activity>
                  
                  <meta-data
                      android:name="flutterEmbedding"
                      android:value="2" />
              </application>
          </manifest>
          EOF

          # gradle.properties mit v2 Embedding Flag
          cat > android/gradle.properties << 'EOF'
          org.gradle.jvmargs=-Xmx1536M
          android.useAndroidX=true
          android.enableJetifier=true
          android.enableR8=true
          flutter.embedding=2
          EOF

          # Cache-Dateien bereinigen
          rm -f .flutter-plugins
          rm -f .flutter-plugins-dependencies
          rm -rf .dart_tool

          echo "✅ Android v2 Migration abgeschlossen"
          
      - name: Fix Dependencies
        working-directory: flutter_app/mrs_unkwn_app
        run: |
          echo "🔧 Dependency-Probleme beheben..."
          
          # Lokalisierung erstellen falls benötigt
          mkdir -p lib/l10n
          cat > lib/l10n/app_localizations.dart << 'EOF'
          import 'package:flutter/material.dart';

          class AppLocalizations {
            static const delegate = _AppLocalizationsDelegate();
            
            static AppLocalizations? of(BuildContext context) {
              return Localizations.of<AppLocalizations>(context, AppLocalizations);
            }
          }

          class _AppLocalizationsDelegate extends LocalizationsDelegate<AppLocalizations> {
            const _AppLocalizationsDelegate();

            @override
            bool isSupported(Locale locale) => true;

            @override
            Future<AppLocalizations> load(Locale locale) async {
              return AppLocalizations();
            }

            @override
            bool shouldReload(_AppLocalizationsDelegate old) => false;
          }
          EOF
          
          # Dependency overrides für kritische Fixes
          cat > pubspec_overrides.yaml << 'EOF'
          dependency_overrides:
            intl: ^0.19.0
            bloc_test: ^9.1.7
            integration_test:
              sdk: flutter
          EOF

          echo "✅ Dependencies repariert"
          
      - name: Install Dependencies
        working-directory: flutter_app/mrs_unkwn_app
        run: |
          echo "📦 Dependencies installieren..."
          
          flutter clean
          
          if flutter pub get; then
            echo "✅ Dependencies erfolgreich installiert"
          else
            echo "❌ Pub get fehlgeschlagen, versuche Cache-Bereinigung..."
            flutter pub cache clean
            dart pub cache clean
            
            if flutter pub get; then
              echo "✅ Dependencies nach Cache-Bereinigung installiert"
            else
              echo "⚠️ Dependencies teilweise fehlgeschlagen, fahre fort..."
            fi
          fi
          
      - name: Verify Android Configuration
        working-directory: flutter_app/mrs_unkwn_app
        run: |
          echo "📋 Android-Konfiguration überprüfen..."
          
          echo "MainActivity-Datei:"
          ls -la android/app/src/main/kotlin/com/mrsunkwn/mrs_unkwn_app/ || echo "MainActivity nicht gefunden"
          
          echo "Flutter Embedding Check:"
          grep "flutterEmbedding" android/app/src/main/AndroidManifest.xml || echo "flutterEmbedding nicht gefunden"
          grep "flutter.embedding" android/gradle.properties || echo "flutter.embedding=2 nicht gefunden"
          
          echo "✅ Konfiguration überprüft"
          
      - name: Build Android APK
        working-directory: flutter_app/mrs_unkwn_app
        run: |
          echo "🤖 Android APK wird erstellt..."
          
          flutter clean
          
          if flutter build apk --debug --target lib/main.dart; then
            echo "✅ Android APK Build erfolgreich!"
            ls -la build/app/outputs/flutter-apk/
          else
            echo "❌ Android APK Build fehlgeschlagen"
            echo "Versuche alternative Build-Optionen..."
            
            if flutter build apk --debug --target lib/main.dart --no-tree-shake-icons; then
              echo "✅ Android APK mit --no-tree-shake-icons erfolgreich!"
            elif flutter build apk --debug --target lib/main.dart --no-pub; then
              echo "✅ Android APK mit --no-pub erfolgreich!"
            else
              echo "❌ Alle Build-Versuche fehlgeschlagen"
              flutter build apk --debug --target lib/main.dart --verbose
              exit 1
            fi
          fi
          
      - name: Upload Android APK
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: flutter_app/mrs_unkwn_app/build/app/outputs/flutter-apk/app-debug.apk
        if: success()
          
      - name: Upload Build Logs
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: flutter_app/mrs_unkwn_app/build/
        if: failure()
